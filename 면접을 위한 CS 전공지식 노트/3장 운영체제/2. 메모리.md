# 메모리

## 1. 메모리 계층
레지스터, 캐시, 메모리, 저장장치로 구성
- 레지스터 :
  CPU 안에 있는 작은 메모리, 휘발성, 속도 가장 빠름, 용량은 가장 적다.
- 캐시 : 
  L1, L2 캐시를 지칭한다. 휘발성, 속도 빠름, 기억 용량이 적다. L3 캐시도 있다.
- 주기억장치 : 
  RAM을 가리킨다. 휘발성, 속도 보통, 기억 용량이 보통이다.
- 보조기억장치 : 
  HDD, SSD 이다. 비휘발성, 속도 낮음, 용량 많다.

게임 같은거 하다 '로딩 중'은 네트워크나 저장장치에서 데이터를 읽어 RAM으로 올리는 작업중을 의미한다.

### 캐시
데이터를 미리 복사해 놓는 임시 저장소이자 빠른 장치와 느린 장치에서 속도 차이로 인한 병목현상을 줄이기 위한 메모리이다.
데이터 접근 시간이 오래 걸리는 것을 해결하고 무언가를 다시 계산하는 작업 시간을 절약할 수 있다.

메모리, CPU 간의 속도 차이가 크기 때문에 레지스터 계층을 두어 속도 차이를 해결한다. 캐싱 계층.

#### 지역성의 원리
지역성은 시간 지역성, 공간 지역성으로 나뉜다.

- 시간 지역성

최근에 사용한 데이터에 다시 접근하려는 특성이다.
반복문의 i변수에 접근하는 것.

- 공간 지역성

최근 접근한 데이터를 이루고 있는 공간이나 가까운 공간에 접근하는 특성이다.
반복문에서 arr에 계속 접근하는 것.

### 캐시히트와 캐시미스
캐시에서 원하는 데이터를 찾으면 캐시히트, 없으면 주메모리에 가서 데이터를 찾아오는 것을 캐시미스.

#### 캐시매핑
캐시가 히트되기 위해 매핑하는 방법.

|이름|설명|
|---|---|
|직접 매핑|메모리가 1\~100, 캐시 1\~10이면 1:1\~10, 2:11\~20 이런식 매핑. 빠르지만 충돌이 많음.|
|연관 매핑|순서 없이 관련 캐시, 메모리 매핑. 충돌 적지만 속도 느림.|
|집합 연관 매핑| 직접 + 연관 |

#### 웹 브라우저의 캐시
대표적으로 쿠키, 로컬 스토리지, 세션 스토리지가 있다.
사용자 정보, 인증 모듈 관련사항 등을 저장.

- 쿠키

만료기한이 있는 키-값 저장소. 4KB까지

- 로컬 스토리지

만료기한이 없는 키-값 저장소. 10MB까지. 브라우저 닫아도 유지. 클라이언트에서만 수정가능.

- 세션 스토리지

만료기한이 없는 키-값 저장소. 5MB까지. 탭을 닫을 때 삭제. 클라이언트에서만 수정가능.

#### 데이터베이스의 캐싱 계층
메인 데이터베이스 위에 레디스(Redis) 데이터베이스 계층을 '캐싱 계층'으로 두어 성능을 향상시키기도 한다.

## 2. 메모리관리
운영체제의 하는 일.
### 가상메모리
가상 메모리는 메모리 관리 기법의 하나. 실제로 이용가능한 메모리 자원을 추상화하여 사용자에게 매우 큰 메모리로 보이게 만드는 것.

가상적으로 주어진 주소를 가상주소(logical address), 실제 메모리에 있는 주소를 실제주소(physical address)라고 한다.
가상주소는 메모리관리장치(MMU)에 의해 실제주소로 변환된다. 사용자는 실제주소를 의식하지 않아도 된다.

가상 메모리는 가상주소와 실제주소가 매핑되어있고 프로세스의 주소정보가 들어있는 '페이지 테이블'로 관리된다. 속도향상을 위해 TLB를 사용한다.

> TLB
>
> 메모리와 CPU 사이에 있는 주소변환을 위한 캐시이다.

#### 스와핑
가상 메모리에는 존재하지만 실제 메모리인 RAM에는 현재 없는 데이터에 접근하는 경우 페이지 폴트가 발생한다.
메모리에 당장 사용하지 않는 영역을 하드디스크로 옮기고 하드디스크의 일부분을 메모리처럼 쓰는 것을 스와핑이라한다.
페이지 폴트가 일어나지 않은 것 처럼 만듬.

#### 페이지 폴트
page fault. 프로세스 주소공간에는 존재하지만 컴퓨터의 RAM에는 없는 데이터에 접근했을 경우 발생.

스와핑 과정

1. CPU가 물리메모리 확인. 페이지 없으면 트랩을 발생해 운영체제에 알림.
2. 운영체제가 CPU 동작 멈춤.
3. 운영체제가 페이지 테이블 확인. 가상메모리에 페이지 존재여부 확인. 없으면 프로세스 중단하고 물리메모리에 비어있는 프레임있는지 찾음. 물리메모리에도 없으면 스와핑 발생.
4. 비어있는 프레임에 해당 페이지를 로드, 페이지 테이블 최신화.
5. 중단된 CPU 다시 시작.

> 페이지(page)
>
> 가상 메모리를 사용하는 최소 크기 단위
>
> 프레임(frame)
>
> 실제 메모리를 사용하는 최소 크기 단위

### 스레싱
스레싱(thrashing)은 메모리의 페이지 폴트율이 높은 것.

메모리에 너무 많은 프로세스가 동시에 올라가면 스와핑이 많이 일어나서 발생한다.

해결 방법은 메모리를 늘리거나, SSD로 변경하는 방법이 있음.
운영체제에서 해결하는 방법은 작업 세트, PFF가 있음.

#### 작업 세트
working set. 프로세스 과거 사용 이력인 지역성(locality)로 결정된 페이지 집합을 만들어서 미리 메모리에 로드하는 것.
미리 로드해서 탐색 비용 줄이고, 스와핑도 줄임.

#### PFF
PFF(Page Fault Frequency). 페이지 폴트 핀도를 조절하는 방법.
상한과 하한을 만든다. 상한선에 도달하면 프레임을 늘리고 하한선에 도달하면 프레임을 줄인다.

### 메모리 할당
프로그램을 메모리에 할당할 때 시작 메모리 위치, 할당 크기를 기반으로 할당함. 연속, 불연속 할당으로 나뉜다.

#### 연속 할당
메모리에 연속적으로 공간을 할당. 순차적으로 할당.

- 고정 분할 방식

  메모리를 미리 나누어 관리하는 방식. 내부 단편화가 발생한다.

- 가변 분할 방식

  매 시점 프로그램의 크기에 맞추어 동적으로 메모리를 나눠 사용한다. 외부 단편화가 발생할 수 있다. 최초적합, 최적적합, 최악적합이 있다.

  - 최초적합 : 위에서부터 비어있는 홀에 바로 할당.
  - 최적적합 : 프로세스 크기 이상인 공간 중 가장 작은 홀에 할당.
  - 최악적합 : 크기 차이가 가장 많이 나는 홀에 할당.

> 홀(hole)
>
> 할당할 수 있는 빈 메모리 공간.

#### 불연속 할당
현대 운영체제가 쓰는 방법으로 불연속 할당인 페이징 기법이 있다.

메모리를 동일한 크기의 페이지(보통 4KB)로 나누고 프로그램마다 페이지 테이블을 두어 메모리에 할당함.

페이징 기법 말고도 세그멘테이션, 페이지드 세그멘테이션이 있다.

- 페이징

  동일한 크기의 페이지 단위로 나눠 메모리의 서로다른 위치에 할당. 홀의 크기가 균일. 주소변환 복잡함.

- 세그멘테이션

  의미 단위인 세그먼트로 나누는 방식. 프로세스를 이루는 메모리는 코드, 데이터, 스택, 힙 영역으로 나뉨. 코드와 데이터로 나누거나, 코드 내의 작은 함수를 세그먼트로 놓고 나눌수도 있다. 공유, 보안에서 장점. 홀 크기가 균일하지 않음.  

- 페이지드 세그멘테이선

  두가지를 합침.

### 페이지 교체 알고리즘
메모리는 한정됨. 스와핑 많이 일어남. 페이지 교체 알고리즘을 기반으로 스와핑이 일어남.

#### 오프라인 알고리즘
미래를 알면 할 수 있겠지?

#### FIFO
First In First Out. 가장 먼저 온 페이지를 교체 영역에 먼저 놓는 방법.

#### LRU
Last Recently Used. 참조가 가장 오래된 페이지를 바꾼다. 오래된 페이지를 파악하기 위해 페이지 마다 계수기, 스택이 필요하다.

- NUR

  LRU에서 발전함. Not Used Recently. 0과 1을 가진 비트를 이용. 1은 최근 참조됨. 0을 찾아 교체. 해당 부분 1로 변경.

#### LFU
Least Frequently Uesd. 가장 참조 횟수가 적은 페이지를 교체.
많이 사용되지 않는거 교체.
