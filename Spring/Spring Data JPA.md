## Spring Data JPA에서 새로운 Entity인지 판단하는 방법은 무엇일까요?

새로운 Entity인지 아닌지 판단해야하는 상황

save() 호출할때 이 엔티티가 새로운것인지 기존 데이터인지 판단해야한다.

일반적으로 @Id 값이 null 인 경우 새로운 엔티티로 판단한다. DB에 insert 수행한다.

@Id 값이 있는 경우에는 DB에 조회를 한 뒤 있으면 update, 없으면 insert를 수행한다.

Spring Data JPA에서 새로운 엔티티를 판단하는 메서드는 isNew() 메서드이다.

### 새로운 Entity인지 판단하는게 왜 중요한가?

save()에서 isNew()를 사용해 persist할것인지 merge할것인지 결정하는데 ID를 직접 지정하는 경우 새로운 엔티티여도 merge를 수행하기 때문에 DB에서 조회가 발생해 비효율적으로 동작한다.

직접 ID를 할당하는 경우에는 엔티티 클래스를 만들때 @Version을 사용하거나 직접 isNew를 오버라이딩해서 로직을 구현하는 방법이 있다.

## JPA의 ddl-auto 옵션?
application.yml 파일에 ddl-auto옵션 설정할 수 있다. 옵션에는 none, validate, update, create, create-drop존재한다. 운영환경에서는 none, validate를 사용해야한다.

- none은 데이터 베이스 스키마 관련 작업을 하지 않겠다는 설정. 수동으로 데이터베이스를 관리하기 위해 사용하는 옵션이다. 운영환경에서 사용해야할 옵션이다.
- validate는 어플리케이션 시작할때 엔티티와 ㅉ이터베이스 테이블이 일치하는지 검증 단계를 수행한다. 스키마 변경은 일어나지 않는다. 이것도 운영환경에서 사용가능하다.
- update는 엔티티와 스키마를 비교하고 변한 부분을 추가로 업데이트 하는 설정이다. 기존 데이터 유지되지만 스키마 변경이 발생하기 때문에 예상과 다르게 변할 수 있다.
- create는 시작될때 기존 스키마 삭제하고 새로 테이블 생성한다.
- create-drop은 create와 유사하다. 차이점은 어플리케이션 종료될때 테이블 삭제한다.

## EntityManager의 역할
영속성 컨텍스트와 관련이 있습니다. 영속성 컨텍스트에 의해 관리되도록 엔티티를 다루기 위한 객체입니다.

엔티티는 영속성 컨텍스트와 관련해 4가지 상태를 가집니다. 비영속, 영속, 준영속, 삭제. 엔티티 매니저는 persist, merge, remove, close 메서드를 사용해 엔티티 상태를 변경할 수 있습니다. 그리고 JPQL이나 Native Query를 사용해 DB로부터 데이터를 불러오는 작업도 수행합니다.



